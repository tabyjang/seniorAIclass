<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¨ë¼ì¸ í¬í†  ì•¨ë²”</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/albums.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo">
            <span class="logo-icon">ğŸ“·</span>
            <span>ì˜¨ë¼ì¸ í¬í†  ì•¨ë²”</span>
        </div>
        <div class="header-right">
            <span id="userInfo" class="user-info"></span>
            <button id="authBtn" class="btn btn-secondary">ë¡œê·¸ì¸</button>
            <button id="newAlbumBtn" class="btn btn-primary">+ ìƒˆ ì•¨ë²”</button>
        </div>
    </header>

    <!-- ë©”ì¸ -->
    <main class="container">
        <h1 class="page-title">ë‚´ ì•¨ë²”</h1>

        <!-- ë¡œê·¸ì¸ í¼ (ë°”ë¡œ í‘œì‹œ) -->
        <div id="loginPrompt" class="login-box">
            <div class="login-icon">ğŸ”</div>
            <h2>ë¡œê·¸ì¸</h2>
            <div class="form-group">
                <label>ì•„ì´ë””</label>
                <input type="text" id="loginId" placeholder="ì•„ì´ë””">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            </div>
            <button id="loginBtn" class="btn btn-primary btn-full">ë¡œê·¸ì¸</button>
            <div class="login-hint">ğŸ’¡ í…ŒìŠ¤íŠ¸: <strong>test</strong> / <strong>1234</strong></div>
        </div>

        <!-- ì•¨ë²” ê·¸ë¦¬ë“œ -->
        <div id="albumGrid" class="album-grid"></div>

        <!-- ì•¨ë²” ì—†ìŒ -->
        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="empty-icon">ğŸ“</div>
            <h3>ì•¨ë²”ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ìƒˆ ì•¨ë²”ì„ ë§Œë“¤ì–´ ì‚¬ì§„ì„ ì •ë¦¬í•˜ì„¸ìš”</p>
            <button class="btn btn-primary" onclick="openNewAlbumModal()">ì²« ì•¨ë²” ë§Œë“¤ê¸°</button>
        </div>
    </main>

    <!-- ìƒˆ ì•¨ë²” ëª¨ë‹¬ -->
    <div id="newAlbumModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ìƒˆ ì•¨ë²” ë§Œë“¤ê¸°</h2>
                <button class="modal-close" onclick="closeNewAlbumModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ì•¨ë²” ì´ë¦„ *</label>
                    <input type="text" id="albumName" placeholder="ì˜ˆ: ê°€ì¡± ì‚¬ì§„">
                </div>
                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="albumDesc" rows="3" placeholder="ì˜ˆ: 2024ë…„ ì¶”ì–µ"></textarea>
                </div>
                <div class="form-group">
                    <label>ë‚ ì§œ</label>
                    <input type="date" id="albumDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNewAlbumModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="createAlbum()">ì•¨ë²” ë§Œë“¤ê¸°</button>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div id="toast" class="toast"></div>

    <!-- config.js ë¡œë“œ -->
    <script src="js/config.js"></script>

    <script>
    // ==========================================
    // í•˜ë“œì½”ë”© ë¡œê·¸ì¸ ì •ë³´
    // ==========================================
    const USERS = {
        'test': '1234',
        'admin': 'admin',
        'user': 'user'
    };

    // ==========================================
    // ë¡œê·¸ì¸ ê´€ë ¨
    // ==========================================
    function isLoggedIn() {
        return localStorage.getItem('album_logged_in') === 'true';
    }

    function getUser() {
        return localStorage.getItem('album_user') || '';
    }

    function login(id, pw) {
        if (USERS[id] && USERS[id] === pw) {
            localStorage.setItem('album_logged_in', 'true');
            localStorage.setItem('album_user', id);
            return true;
        }
        return false;
    }

    function logout() {
        localStorage.removeItem('album_logged_in');
        localStorage.removeItem('album_user');
        location.reload();
    }

    // ==========================================
    // ëª¨ë‹¬
    // ==========================================
    function openNewAlbumModal() {
        if (!isLoggedIn()) {
            showToast('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”', 'error');
            return;
        }
        document.getElementById('newAlbumModal').classList.add('show');
    }

    function closeNewAlbumModal() {
        document.getElementById('newAlbumModal').classList.remove('show');
        document.getElementById('albumName').value = '';
        document.getElementById('albumDesc').value = '';
        document.getElementById('albumDate').value = '';
    }

    // ==========================================
    // UI ì—…ë°ì´íŠ¸
    // ==========================================
    function updateUI() {
        const authBtn = document.getElementById('authBtn');
        const userInfo = document.getElementById('userInfo');
        const loginPrompt = document.getElementById('loginPrompt');
        const albumGrid = document.getElementById('albumGrid');
        const emptyState = document.getElementById('emptyState');

        if (isLoggedIn()) {
            authBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
            authBtn.style.display = 'inline-flex';
            authBtn.onclick = logout;
            userInfo.textContent = 'ğŸ‘¤ ' + getUser();
            userInfo.style.display = 'inline';
            loginPrompt.style.display = 'none';
        } else {
            authBtn.style.display = 'none';
            userInfo.style.display = 'none';
            loginPrompt.style.display = 'block';
            albumGrid.style.display = 'none';
            emptyState.style.display = 'none';
        }
    }

    // ==========================================
    // Supabase
    // ==========================================
    var db = null;

    function getSupabase() {
        if (!db) {
            if (typeof CONFIG === 'undefined') {
                alert('ì„¤ì • íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨. Live Serverë¡œ ì‹¤í–‰í•˜ì„¸ìš”.');
                return null;
            }
            db = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        }
        return db;
    }

    // ==========================================
    // ì•¨ë²” ë¡œë“œ
    // ==========================================
    async function loadAlbums() {
        console.log('loadAlbums ì‹œì‘');
        if (!isLoggedIn()) {
            console.log('ë¡œê·¸ì¸ ì•ˆë¨');
            return;
        }

        const client = getSupabase();
        console.log('Supabase í´ë¼ì´ì–¸íŠ¸:', client);
        if (!client) {
            console.log('í´ë¼ì´ì–¸íŠ¸ ì—†ìŒ');
            return;
        }

        const albumGrid = document.getElementById('albumGrid');
        const emptyState = document.getElementById('emptyState');

        try {
            console.log('ì•¨ë²” ì¡°íšŒ ì‹œì‘...');
            const { data: albums, error } = await client
                .from('albums')
                .select('*')
                .order('created_at', { ascending: false });

            console.log('ì•¨ë²” ê²°ê³¼:', albums, 'ì—ëŸ¬:', error);
            if (error) throw error;

            // ê° ì•¨ë²”ì˜ ì‚¬ì§„ ìˆ˜ ê°€ì ¸ì˜¤ê¸° (ìƒëµ - ë‚˜ì¤‘ì—)
            for (const album of albums) {
                album.photoCount = 0;
            }

            console.log('ì•¨ë²” ê°œìˆ˜:', albums.length);
            if (albums.length === 0) {
                albumGrid.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                console.log('ì•¨ë²” í‘œì‹œ ì‹œì‘');
                albumGrid.style.display = 'grid';
                emptyState.style.display = 'none';
                renderAlbums(albums);
                console.log('ë Œë”ë§ ì™„ë£Œ, albumGrid ë‚´ìš©:', albumGrid.innerHTML.substring(0, 200));
            }
        } catch (err) {
            console.error('ì•¨ë²” ë¡œë“œ ì˜¤ë¥˜:', err);
            showToast('ì•¨ë²”ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message, 'error');
        }
    }

    // ==========================================
    // ì•¨ë²” ë Œë”ë§
    // ==========================================
    function renderAlbums(albums) {
        const grid = document.getElementById('albumGrid');
        grid.innerHTML = '';

        albums.forEach(album => {
            console.log('ì•¨ë²” ë Œë”ë§:', album); // ë””ë²„ê¹…
            const card = document.createElement('div');
            card.className = 'album-card';
            card.onclick = () => {
                console.log('í´ë¦­í•œ ì•¨ë²”:', album);
                console.log('ì•¨ë²” ID:', album.id);
                const url = `gallery.html#${album.id}`;
                console.log('ì´ë™í•  URL:', url);
                location.href = url;
            };

            // ì»¤ë²„ ì´ë¯¸ì§€
            const cover = document.createElement('div');
            cover.className = 'album-cover';
            if (album.cover_image_url) {
                cover.style.backgroundImage = `url('${album.cover_image_url}')`;
            } else {
                cover.innerHTML = '<span style="font-size:48px;">ğŸ“·</span>';
                cover.style.display = 'flex';
                cover.style.alignItems = 'center';
                cover.style.justifyContent = 'center';
                cover.style.background = '#f0f0f0';
            }

            // ì•¨ë²” ì •ë³´
            const info = document.createElement('div');
            info.className = 'album-info';
            info.innerHTML = `
                <h3 class="album-name">${album.name}</h3>
                <p class="album-meta">${album.photoCount}ì¥ì˜ ì‚¬ì§„</p>
            `;

            card.appendChild(cover);
            card.appendChild(info);
            grid.appendChild(card);
        });
    }

    // ==========================================
    // ì•¨ë²” ìƒì„±
    // ==========================================
    async function createAlbum() {
        const name = document.getElementById('albumName').value.trim();
        const desc = document.getElementById('albumDesc').value.trim();
        const date = document.getElementById('albumDate').value;

        if (!name) {
            showToast('ì•¨ë²” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
            return;
        }

        const client = getSupabase();
        if (!client) return;

        try {
            const { error } = await client
                .from('albums')
                .insert({
                    name: name,
                    description: desc || '',
                    date: date || null
                });

            if (error) throw error;

            showToast('ì•¨ë²”ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            closeNewAlbumModal();
            loadAlbums();
        } catch (err) {
            console.error('ì•¨ë²” ìƒì„± ì˜¤ë¥˜:', err);
            showToast('ì•¨ë²” ìƒì„± ì‹¤íŒ¨: ' + err.message, 'error');
        }
    }

    // ==========================================
    // í† ìŠ¤íŠ¸
    // ==========================================
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ==========================================
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        // ë¡œê·¸ì¸ ë²„íŠ¼
        document.getElementById('loginBtn').onclick = function() {
            const id = document.getElementById('loginId').value.trim();
            const pw = document.getElementById('loginPw').value;

            console.log('ë¡œê·¸ì¸ ì‹œë„:', id, pw);

            if (!id || !pw) {
                alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            if (login(id, pw)) {
                alert('ë¡œê·¸ì¸ ì„±ê³µ!');
                location.reload();
            } else {
                alert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤');
            }
        };

        // ì—”í„°í‚¤ë¡œ ë¡œê·¸ì¸
        document.getElementById('loginPw').onkeypress = function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        };

        // ìƒˆ ì•¨ë²” ë²„íŠ¼
        document.getElementById('newAlbumBtn').onclick = openNewAlbumModal;

        // ì´ˆê¸°í™”
        console.log('í˜ì´ì§€ ë¡œë“œ, ë¡œê·¸ì¸ ìƒíƒœ:', isLoggedIn());
        updateUI();
        if (isLoggedIn()) {
            console.log('ë¡œê·¸ì¸ë¨ - loadAlbums í˜¸ì¶œ');
            loadAlbums();
        }
    });
    </script>

    <style>
    .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .user-info {
        font-size: 14px;
        color: #666;
    }
    .btn-full {
        width: 100%;
        margin-top: 16px;
    }
    .login-box {
        max-width: 400px;
        margin: 60px auto;
        padding: 40px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        text-align: center;
    }
    .login-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    .login-box h2 {
        margin-bottom: 24px;
        color: #333;
    }
    .login-box .form-group {
        text-align: left;
    }
    .login-hint {
        margin-top: 20px;
        padding: 12px;
        background: #f5f5f5;
        border-radius: 8px;
        font-size: 14px;
        color: #666;
    }
    </style>
</body>
</html>
