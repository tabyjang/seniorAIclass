<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°¤ëŸ¬ë¦¬ - ì˜¨ë¼ì¸ í¬í†  ì•¨ë²”</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/gallery.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="logo" onclick="location.href='albums.html'" style="cursor:pointer;">
            <span class="logo-icon">ğŸ“·</span>
            <span>ì˜¨ë¼ì¸ í¬í†  ì•¨ë²”</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                ğŸ“¤ ì‚¬ì§„ ì¶”ê°€
            </button>
        </div>
    </header>

    <!-- ë©”ì¸ -->
    <main class="container">
        <!-- ì•¨ë²” ì •ë³´ -->
        <div class="album-header">
            <div>
                <button class="btn btn-text" onclick="location.href='albums.html'">â† ëª©ë¡ìœ¼ë¡œ</button>
                <h1 id="albumTitle">ì•¨ë²”</h1>
                <p id="albumInfo"></p>
            </div>
            <div class="album-actions">
                <button class="btn btn-secondary" onclick="startSlideshow()">â–¶ï¸ ìŠ¬ë¼ì´ë“œì‡¼</button>
                <button class="btn btn-danger" onclick="deleteAlbum()">ğŸ—‘ï¸ ì•¨ë²” ì‚­ì œ</button>
            </div>
        </div>

        <!-- ì—…ë¡œë“œ ì˜ì—­ -->
        <div id="dropZone" class="drop-zone">
            <div class="drop-content">
                <span class="drop-icon">ğŸ“</span>
                <p>ì‚¬ì§„ì„ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
                <p class="drop-hint">ë˜ëŠ” í´ë¦­í•´ì„œ ì„ íƒ (JPG, PNG, GIF, WebP)</p>
            </div>
            <input type="file" id="fileInput" multiple accept="image/*" style="display:none;">
        </div>

        <!-- ê°¤ëŸ¬ë¦¬ -->
        <div id="gallery" class="gallery"></div>

        <!-- ë¹ˆ ìƒíƒœ -->
        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="empty-icon">ğŸ–¼ï¸</div>
            <h3>ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ìœ„ì—ì„œ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
        </div>
    </main>

    <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
    <div id="uploadProgress" class="upload-progress" style="display:none;">
        <h4>ğŸ“¤ ì—…ë¡œë“œ ì¤‘...</h4>
        <div class="progress-bar">
            <div id="progressBar" class="progress-fill"></div>
        </div>
        <p id="progressText">0 / 0</p>
    </div>

    <!-- ë¼ì´íŠ¸ë°•ìŠ¤ -->
    <div id="lightbox" class="lightbox">
        <button class="lb-close" onclick="closeLightbox()">&times;</button>
        <button class="lb-nav lb-prev" onclick="prevPhoto()">â€¹</button>
        <button class="lb-nav lb-next" onclick="nextPhoto()">â€º</button>
        <div class="lb-content">
            <img id="lbImage" src="" alt="">
            <div class="lb-info">
                <span id="lbCounter">1 / 1</span>
                <div class="lb-actions">
                    <button class="btn btn-icon" onclick="toggleFavorite()" id="favBtn">ğŸ¤</button>
                    <button class="btn btn-icon" onclick="downloadPhoto()">ğŸ’¾</button>
                    <button class="btn btn-icon btn-danger" onclick="deletePhoto()">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div id="toast" class="toast"></div>

    <!-- config.js -->
    <script src="js/config.js"></script>

    <script>
    // ==========================================
    // ì „ì—­ ë³€ìˆ˜
    // ==========================================
    let albumId = null;
    let album = null;
    let photos = [];
    let currentIndex = 0;
    var db = null;
    let slideshowTimer = null;

    // ==========================================
    // ì´ˆê¸°í™”
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('=== index.html ë¡œë“œ ì‹œì‘ ===');

        // ë¡œê·¸ì¸ ì²´í¬
        const loggedIn = localStorage.getItem('album_logged_in');
        console.log('ë¡œê·¸ì¸ ìƒíƒœ:', loggedIn);
        if (loggedIn !== 'true') {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            location.href = 'albums.html';
            return;
        }

        // URLì—ì„œ ì•¨ë²” ID (hash ì‚¬ìš©: gallery.html#ì•¨ë²”ID)
        console.log('í˜„ì¬ URL:', location.href);
        console.log('location.hash:', location.hash);
        albumId = location.hash.replace('#', '');
        console.log('ì•¨ë²” ID:', albumId);

        if (!albumId) {
            console.log('ì•¨ë²” IDê°€ ì—†ìŒ! URLì„ í™•ì¸í•˜ì„¸ìš”.');
            alert('ì•¨ë²” ID ì—†ìŒ. URL: ' + location.href);
            location.href = 'albums.html';
            return;
        }

        // Supabase ì´ˆê¸°í™”
        console.log('CONFIG:', typeof CONFIG);
        if (typeof CONFIG === 'undefined') {
            alert('ì„¤ì • íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return;
        }
        db = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
        console.log('Supabase ì´ˆê¸°í™” ì™„ë£Œ');

        // ë“œë˜ê·¸ì•¤ë“œë¡­ ì„¤ì •
        setupDropZone();
        console.log('ë“œë¡­ì¡´ ì„¤ì • ì™„ë£Œ');

        // ë°ì´í„° ë¡œë“œ
        loadAlbum();
        loadPhotos();
        console.log('=== ì´ˆê¸°í™” ì™„ë£Œ ===');
    });

    // ==========================================
    // ì•¨ë²” ë¡œë“œ
    // ==========================================
    async function loadAlbum() {
        console.log('loadAlbum ì‹œì‘, albumId:', albumId);
        try {
            const { data, error } = await db
                .from('albums')
                .select('*')
                .eq('id', albumId)
                .single();

            console.log('ì•¨ë²” ì¡°íšŒ ê²°ê³¼:', data, error);
            if (error) throw error;

            album = data;
            document.getElementById('albumTitle').textContent = data.name;
            console.log('ì•¨ë²” ë¡œë“œ ì„±ê³µ:', data.name);
        } catch (err) {
            console.error('ì•¨ë²” ë¡œë“œ ì˜¤ë¥˜:', err);
            alert('ì•¨ë²” ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
            // setTimeout(() => location.href = 'albums.html', 2000);
        }
    }

    // ==========================================
    // ì‚¬ì§„ ë¡œë“œ
    // ==========================================
    async function loadPhotos() {
        try {
            const { data, error } = await db
                .from('photos')
                .select('*')
                .eq('album_id', albumId)
                .order('created_at', { ascending: false });

            if (error) throw error;

            photos = data || [];
            document.getElementById('albumInfo').textContent = `${photos.length}ì¥ì˜ ì‚¬ì§„`;
            renderGallery();
        } catch (err) {
            console.error('ì‚¬ì§„ ë¡œë“œ ì˜¤ë¥˜:', err);
            showToast('ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
        }
    }

    // ==========================================
    // ê°¤ëŸ¬ë¦¬ ë Œë”ë§
    // ==========================================
    function renderGallery() {
        const gallery = document.getElementById('gallery');
        const emptyState = document.getElementById('emptyState');

        if (photos.length === 0) {
            gallery.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        gallery.style.display = 'grid';
        emptyState.style.display = 'none';
        gallery.innerHTML = '';

        photos.forEach((photo, index) => {
            const card = document.createElement('div');
            card.className = 'photo-card';
            card.onclick = () => openLightbox(index);

            const img = document.createElement('img');
            img.src = photo.file_url;
            img.alt = photo.file_name;
            img.loading = 'lazy';

            card.appendChild(img);

            if (photo.is_favorite) {
                const badge = document.createElement('span');
                badge.className = 'fav-badge';
                badge.textContent = 'â¤ï¸';
                card.appendChild(badge);
            }

            gallery.appendChild(card);
        });
    }

    // ==========================================
    // ë“œë˜ê·¸ì•¤ë“œë¡­
    // ==========================================
    function setupDropZone() {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        // í´ë¦­
        dropZone.onclick = () => fileInput.click();

        // íŒŒì¼ ì„ íƒ
        fileInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                uploadFiles(e.target.files);
            }
        };

        // ë“œë˜ê·¸ ì˜¤ë²„
        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        };

        // ë“œë˜ê·¸ ë– ë‚¨
        dropZone.ondragleave = () => {
            dropZone.classList.remove('drag-over');
        };

        // ë“œë¡­
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                uploadFiles(e.dataTransfer.files);
            }
        };
    }

    // ==========================================
    // íŒŒì¼ ì—…ë¡œë“œ
    // ==========================================
    async function uploadFiles(fileList) {
        const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));

        if (files.length === 0) {
            showToast('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
            return;
        }

        // ì§„í–‰ë¥  UI
        const progressUI = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        progressUI.style.display = 'block';

        let success = 0;
        let failed = 0;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            // í¬ê¸° ì²´í¬
            if (file.size > CONFIG.MAX_FILE_SIZE) {
                showToast(`${file.name}: 10MB ì´ˆê³¼`, 'error');
                failed++;
                continue;
            }

            try {
                // íŒŒì¼ ê²½ë¡œ
                const ext = file.name.split('.').pop().toLowerCase();
                const filePath = `uploads/${albumId}/${Date.now()}_${i}.${ext}`;

                // Storage ì—…ë¡œë“œ
                const { error: uploadError } = await db.storage
                    .from(CONFIG.STORAGE_BUCKET)
                    .upload(filePath, file);

                if (uploadError) throw uploadError;

                // Public URL
                const { data: urlData } = db.storage
                    .from(CONFIG.STORAGE_BUCKET)
                    .getPublicUrl(filePath);

                // DB ì €ì¥
                const { error: dbError } = await db
                    .from('photos')
                    .insert({
                        album_id: albumId,
                        file_name: file.name,
                        file_url: urlData.publicUrl,
                        file_size: file.size
                    });

                if (dbError) throw dbError;

                // ì²« ì‚¬ì§„ì´ë©´ ì•¨ë²” ì»¤ë²„ë¡œ
                if (photos.length === 0 && success === 0) {
                    await db
                        .from('albums')
                        .update({ cover_image_url: urlData.publicUrl })
                        .eq('id', albumId);
                }

                success++;
            } catch (err) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', err);
                failed++;
            }

            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            const percent = Math.round(((i + 1) / files.length) * 100);
            progressBar.style.width = percent + '%';
            progressText.textContent = `${i + 1} / ${files.length}`;
        }

        // ì™„ë£Œ
        progressUI.style.display = 'none';
        progressBar.style.width = '0%';
        document.getElementById('fileInput').value = '';

        if (failed > 0) {
            showToast(`${success}ì¥ ì„±ê³µ, ${failed}ì¥ ì‹¤íŒ¨`, 'warning');
        } else {
            showToast(`${success}ì¥ ì—…ë¡œë“œ ì™„ë£Œ!`, 'success');
        }

        loadPhotos();
    }

    // ==========================================
    // ë¼ì´íŠ¸ë°•ìŠ¤
    // ==========================================
    function openLightbox(index) {
        currentIndex = index;
        updateLightbox();
        document.getElementById('lightbox').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
        document.getElementById('lightbox').classList.remove('show');
        document.body.style.overflow = '';
        if (slideshowTimer) {
            clearInterval(slideshowTimer);
            slideshowTimer = null;
        }
    }

    function updateLightbox() {
        const photo = photos[currentIndex];
        if (!photo) return;

        document.getElementById('lbImage').src = photo.file_url;
        document.getElementById('lbCounter').textContent = `${currentIndex + 1} / ${photos.length}`;
        document.getElementById('favBtn').textContent = photo.is_favorite ? 'â¤ï¸' : 'ğŸ¤';
    }

    function prevPhoto() {
        currentIndex = (currentIndex - 1 + photos.length) % photos.length;
        updateLightbox();
    }

    function nextPhoto() {
        currentIndex = (currentIndex + 1) % photos.length;
        updateLightbox();
    }

    // í‚¤ë³´ë“œ
    document.addEventListener('keydown', (e) => {
        const lb = document.getElementById('lightbox');
        if (!lb.classList.contains('show')) return;

        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowLeft') prevPhoto();
        if (e.key === 'ArrowRight') nextPhoto();
    });

    // ==========================================
    // ì‚¬ì§„ ê¸°ëŠ¥
    // ==========================================
    async function toggleFavorite() {
        const photo = photos[currentIndex];
        const newValue = !photo.is_favorite;

        try {
            await db
                .from('photos')
                .update({ is_favorite: newValue })
                .eq('id', photo.id);

            photo.is_favorite = newValue;
            updateLightbox();
            renderGallery();
            showToast(newValue ? 'ì¦ê²¨ì°¾ê¸° ì¶”ê°€' : 'ì¦ê²¨ì°¾ê¸° í•´ì œ', 'success');
        } catch (err) {
            showToast('ì˜¤ë¥˜: ' + err.message, 'error');
        }
    }

    function downloadPhoto() {
        const photo = photos[currentIndex];
        const link = document.createElement('a');
        link.href = photo.file_url;
        link.download = photo.file_name;
        link.click();
    }

    async function deletePhoto() {
        if (!confirm('ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const photo = photos[currentIndex];

        try {
            // Storageì—ì„œ ì‚­ì œ
            const path = photo.file_url.split('/photos/')[1];
            if (path) {
                await db.storage.from(CONFIG.STORAGE_BUCKET).remove([path]);
            }

            // DBì—ì„œ ì‚­ì œ
            await db.from('photos').delete().eq('id', photo.id);

            showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            closeLightbox();
            loadPhotos();
        } catch (err) {
            showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
        }
    }

    // ==========================================
    // ìŠ¬ë¼ì´ë“œì‡¼
    // ==========================================
    function startSlideshow() {
        if (photos.length === 0) {
            showToast('ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤', 'error');
            return;
        }

        openLightbox(0);
        slideshowTimer = setInterval(nextPhoto, 3000);
        showToast('ìŠ¬ë¼ì´ë“œì‡¼ ì‹œì‘ (ESCë¡œ ì¢…ë£Œ)', 'info');
    }

    // ==========================================
    // ì•¨ë²” ì‚­ì œ
    // ==========================================
    async function deleteAlbum() {
        if (!confirm('ì´ ì•¨ë²”ê³¼ ëª¨ë“  ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            // ëª¨ë“  ì‚¬ì§„ ì‚­ì œ
            for (const photo of photos) {
                const path = photo.file_url.split('/photos/')[1];
                if (path) {
                    await db.storage.from(CONFIG.STORAGE_BUCKET).remove([path]);
                }
            }

            await db.from('photos').delete().eq('album_id', albumId);
            await db.from('albums').delete().eq('id', albumId);

            showToast('ì•¨ë²”ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            setTimeout(() => location.href = 'albums.html', 1500);
        } catch (err) {
            showToast('ì‚­ì œ ì‹¤íŒ¨: ' + err.message, 'error');
        }
    }

    // ==========================================
    // í† ìŠ¤íŠ¸
    // ==========================================
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    </script>

    <style>
    .album-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }
    .album-actions {
        display: flex;
        gap: 8px;
    }
    .drop-zone {
        border: 3px dashed #ccc;
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        margin-bottom: 24px;
        cursor: pointer;
        transition: all 0.3s;
        background: #fafafa;
    }
    .drop-zone:hover, .drop-zone.drag-over {
        border-color: #7A8B6E;
        background: #f0f5ee;
    }
    .drop-icon { font-size: 48px; }
    .drop-hint { color: #999; font-size: 14px; margin-top: 8px; }

    .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
    }
    .photo-card {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        aspect-ratio: 1;
    }
    .photo-card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s;
    }
    .photo-card:hover img { transform: scale(1.05); }
    .fav-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .upload-progress {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        min-width: 250px;
        z-index: 1000;
    }
    .progress-bar {
        height: 8px;
        background: #eee;
        border-radius: 4px;
        overflow: hidden;
        margin: 12px 0 8px;
    }
    .progress-fill {
        height: 100%;
        background: #7A8B6E;
        transition: width 0.3s;
    }

    .lightbox {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }
    .lightbox.show { display: flex; }
    .lb-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        color: white;
        font-size: 40px;
        cursor: pointer;
    }
    .lb-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        font-size: 48px;
        padding: 20px;
        cursor: pointer;
        border-radius: 8px;
    }
    .lb-prev { left: 20px; }
    .lb-next { right: 20px; }
    .lb-content {
        text-align: center;
        max-width: 90%;
        max-height: 90%;
    }
    .lb-content img {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 8px;
    }
    .lb-info {
        margin-top: 16px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 24px;
    }
    .lb-actions {
        display: flex;
        gap: 8px;
    }
    .btn-icon {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        border: none;
        font-size: 20px;
        cursor: pointer;
    }
    .btn-icon:hover { background: rgba(255,255,255,0.3); }
    </style>
</body>
</html>
